---
title: "Gaussian Mixture"
subtitle: "Development"
author: 
 - name: Matthias Kloft
   orcid: 0000-0003-1845-6957
date: "`r Sys.Date()`"
format:
  html:
    toc: true
    toc-depth: 3
    code-fold: show
    source: repo
    code-tools: true
    df-print: paged
execute:
  warning: true
  message: true
---

## Overview



## Setup and Data Preparation

```{r setup}
packages <- c(
  "psychinterpreter",
  "ellmer",
  "ollamar",
  "psych",
  "lavaan",
  "mirt",
  "mclust",
  "dplyr",
  "here",
  "kableExtra",
  "pander"
)
# Load required packages using pacman
if (!require("pacman")) install.packages("pacman")
pacman::p_load(char = packages)

# Load the BFI dataset and dictionary
data("bfi")
data("bfi.dictionary")
```

# Preparing the BFI Data

Exclude demographic variables for factor analysis

```{r}
bfi <- bfi[,1:25]
bfi.dictionary <- bfi.dictionary[1:25, ]
```

Show the first few rows of the BFI data:
```{r data-exploration}
head(bfi,10) |> DT::datatable(options = list(scrollX = TRUE))
```

Display the BFI dictionary showing item descriptions:
```{r}
bfi.dictionary |> select(Item) |> as.data.frame()|> DT::datatable(options = list(scrollX = TRUE))
```


# Factor Analysis

## Determining Number of Factors

```{r parallel-analysis}
# Parallel analysis to determine optimal number of factors
pa_result <- fa.parallel(
  bfi,
  fa = "fa",
  n.iter = 100,
  use = "pairwise.complete.obs",
  main = "Parallel Analysis: BFI Data"
)
```

## Exploratory Factor Analysis Using 6 Factors

Perform FA with 6 factors identified by the parallel analysis
```{r fa-analysis}
fa_result <- psych::fa(
  bfi,
  nfactors = pa_result$nfact, 
  rotate = "oblimin",
)
summary(fa_result)
```

Loadings:
```{r}
# Extract loading matrix for interpretation
loadings_matrix <- unclass(fa_result$loadings) |> as.data.frame()
round(loadings_matrix, 2) |> DT::datatable(options = list(scrollX = TRUE))
```

Factor Correlation Matrix
```{r}
# Extract factor correlation matrix
factor_cor_mat <- fa_result$Phi |> as.data.frame()
round(factor_cor_mat, 2) |> DT::datatable(options = list(scrollX = TRUE))
```


## Interpreting Factor Analysis Results

Create variable information dataframe from BFI dictionary
```{r test-basic-interpretation}
variable_info <- data.frame(
  variable = rownames(bfi.dictionary),
  description = as.character(bfi.dictionary$Item),
  stringsAsFactors = FALSE
)

head(variable_info) |> DT::datatable(options = list(scrollX = TRUE))
```

We now generate factor interpretations using the specified LLM:
```{r}
ollamar::list_models()

#show_interpret_args("fa")
#Sys.setenv(ANTHROPIC_API_KEY = "")
provider <- "anthropic"
llm <- ellmer::models_anthropic()[1,"id"]
```

```{r interpret-with-chat}
word_limit <- 50

result <- interpret(
  fit_results = fa_result,
  llm_provider = provider,
  llm_model = llm,
  # set temperature and seed for reproducibility
  params = params(temperature = 0, seed = 42),
  variable_info = variable_info,
  cutoff = 0.3,
  hide_low_loadings = TRUE,
  n_emergency = 2,
  additional_info = NULL,
  sort_loadings = TRUE,
  word_limit =  word_limit
)
```
Let's do a cluster analysis on the factor scores using a Gaussian Mixture Model (GMM).

## Cluster Analysis (Gaussian Mixture Model)

Extract factor scores
```{r usage1}
fa_scores <- fa_result$scores |> 
  # remove rows with NAs
  na.omit()

# add names from interpretation
colnames(fa_scores) <- result$suggested_names

head(fa_scores) |> round(2) |> DT::datatable(options = list(scrollX = TRUE))

```


Find Best Gaussian Mixture Model
```{r}
gmm_model <- mclustICL(ggplot2::remove_missing(bfi), G = 1:10, prior = priorControl())

summary(gmm_model)
plot(gmm_model)
```

Fit the Best Model
```{r}
best_model <- pickBIC(gmm_model)
# extract model name from best_model$names
model_name <- names(best_model)[1] |> stringr::str_extract("[A-Z]{3}")
n_clusters <- names(best_model)[1] |> stringr::str_extract("[1-9]") |> as.integer()
# Run mclust with automatic model and cluster selection
gm_result <- mclust::Mclust(
  ggplot2::remove_missing(bfi),
  G = n_clusters,
  modelNames = model_name,
  warn = TRUE,
  prior = priorControl()
)

summary(gm_result)
```

Get the mean vector, covariance matrix, and mixing proportions from the model fit.

Means:
```{r}
gmm_means <- gm_result$parameters$mean
head(gmm_means) |> round(2) |> DT::datatable(options = list(scrollX = TRUE))
```

Covariance Matrix:
```{r}
gmm_covariances <- gm_result$parameters$variance$sigma
head(gmm_covariances[,,1]) |> round(2) |> DT::datatable(options = list(scrollX = TRUE))
```

Mixing proportions
```{r}
gmm_proportions <- gm_result$parameters$pro
gmm_proportions |> as.data.frame() |> round(3) |> DT::datatable(options = list(scrollX = TRUE))
```

z matrix as the membership grades for every person
```{r}
gmm_z <- gm_result$z
head(gmm_z) |> round(3) |> DT::datatable(options = list(scrollX = TRUE))
```




```{r}
variable_info_gmm <- data.frame(
  variable = colnames(fa_scores),
  description = result$component_summaries |> purrr::map(function(x) x$llm_interpretation) |> unlist()
)
```

```{r}
# Get interpretation
result <- interpret(
  fit_results = gm_result,
  variable_info = variable_info,
  llm_provider = provider,
  llm_model = llm,
  weight_by_uncertainty = TRUE,
  word_limit = 50
)
```

```{r}
plot(result, plot_type = "all", orientation = "vertical")
```





# Session Info
```{r}
pander::pander(sessionInfo())
```

