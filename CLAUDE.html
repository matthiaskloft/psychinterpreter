<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>CLAUDE.md • psychinterpreter</title><!-- mathjax math --><script src="https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-mml-chtml.js" integrity="sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI=" crossorigin="anonymous"></script><script>
  window.MathJax = {
    chtml: {
      fontURL: "https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/output/chtml/fonts/woff-v2"
    }
  };
</script><script src="lightswitch.js"></script><script src="deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet"><link href="deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet"><script src="deps/headroom-0.11.0/headroom.min.js"></script><script src="deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="deps/search-1.0.0/fuse.min.js"></script><script src="deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="pkgdown.js"></script><meta property="og:title" content="CLAUDE.md"></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top " aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="index.html">psychinterpreter</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.0.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="nav-item"><a class="nav-link" href="reference/index.html">Reference</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles"><li><a class="dropdown-item" href="articles/01-Basic_Usage.html">psychinterpreter: Getting Started</a></li>
  </ul></li>
<li class="nav-item"><a class="nav-link" href="news/index.html">Changelog</a></li>
      </ul><ul class="navbar-nav"><li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="search.json"></form></li>
<li class="nav-item"><a class="nav-link" href="https://github.com/matthiaskloft/psychinterpreter/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-lightswitch" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true" aria-label="Light switch"><span class="fa fa-sun"></span></button>
  <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdown-lightswitch"><li><button class="dropdown-item" data-bs-theme-value="light"><span class="fa fa-sun"></span> Light</button></li>
    <li><button class="dropdown-item" data-bs-theme-value="dark"><span class="fa fa-moon"></span> Dark</button></li>
    <li><button class="dropdown-item" data-bs-theme-value="auto"><span class="fa fa-adjust"></span> Auto</button></li>
  </ul></li>
      </ul></div>


  </div>
</nav><div class="container template-title-body">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>CLAUDE.md</h1>
      <small class="dont-index">Source: <a href="https://github.com/matthiaskloft/psychinterpreter/blob/HEAD/CLAUDE.md"><code>CLAUDE.md</code></a></small>
    </div>

<div id="claudemd" class="section level1">

<p>This file provides guidance to Claude Code when working with the <strong>psychinterpreter</strong> R package.</p>
<div class="section level2">
<h2 id="package-overview">Package Overview<a class="anchor" aria-label="anchor" href="#package-overview"></a></h2>
<p><strong>psychinterpreter</strong> automates interpretation of exploratory factor analysis (EFA) results using Large Language Models via the <code>ellmer</code> package. It interfaces with OpenAI, Anthropic, Ollama, Gemini, and Azure to generate human-readable factor names and interpretations.</p>
</div>
<div class="section level2">
<h2 id="core-architecture">Core Architecture<a class="anchor" aria-label="anchor" href="#core-architecture"></a></h2>
<div class="section level3">
<h3 id="llm-powered-interpretation-pipeline">LLM-Powered Interpretation Pipeline<a class="anchor" aria-label="anchor" href="#llm-powered-interpretation-pipeline"></a></h3>
<ol style="list-style-type: decimal"><li>
<strong>Factor Analysis Preparation</strong> (R/fa_utilities.R):
<ul><li>Analyzes loadings against configurable cutoffs</li>
<li>Identifies significant loadings per factor</li>
<li>Applies “emergency rule” for weak factors (uses top N variables if none exceed cutoff)</li>
<li>Detects cross-loadings and orphaned variables</li>
</ul></li>
<li>
<strong>LLM Communication</strong> (R/interpret_fa.R, ~1350 lines):
<ul><li>Constructs structured prompts with psychometric context</li>
<li>Processes ALL factors in a single LLM call (batch optimization)</li>
<li>Includes factor correlations for oblique rotations</li>
<li>Supports persistent chat sessions via <code>chat_fa</code> objects to save tokens</li>
</ul></li>
<li>
<strong>Report Generation</strong> (R/fa_report_functions.R):
<ul><li>Builds reports in text or markdown format</li>
<li>Includes interpretations, cross-loadings, and diagnostics</li>
<li>Text wrapping for console output</li>
</ul></li>
</ol></div>
<div class="section level3">
<h3 id="persistent-chat-sessions">Persistent Chat Sessions<a class="anchor" aria-label="anchor" href="#persistent-chat-sessions"></a></h3>
<p><strong>Key innovation</strong>: <code>chat_fa</code> objects (R/chat_fa.R) are reusable LLM sessions that preserve the system prompt. - Single analysis: Creates temporary session - Multiple analyses: Create one <code>chat_fa</code>, pass to multiple <code><a href="reference/interpret_fa.html">interpret_fa()</a></code> calls - Saves ~500+ tokens per additional analysis</p>
</div>
<div class="section level3">
<h3 id="s3-methods-for-common-fa-packages">S3 Methods for Common FA Packages<a class="anchor" aria-label="anchor" href="#s3-methods-for-common-fa-packages"></a></h3>
<p>The <code><a href="reference/interpret.html">interpret()</a></code> generic (R/interpret_methods.R) auto-extracts loadings from: - <code><a href="https://rdrr.io/pkg/psych/man/fa.html" class="external-link">psych::fa()</a></code> and <code><a href="https://rdrr.io/pkg/psych/man/principal.html" class="external-link">psych::principal()</a></code> results - <code><a href="https://rdrr.io/pkg/lavaan/man/cfa.html" class="external-link">lavaan::cfa()</a></code>, <code><a href="https://rdrr.io/pkg/lavaan/man/sem.html" class="external-link">lavaan::sem()</a></code>, and <code><a href="https://rdrr.io/pkg/lavaan/man/efa.html" class="external-link">lavaan::efa()</a></code> results - <code><a href="https://philchalmers.github.io/mirt/reference/mirt.html" class="external-link">mirt::mirt()</a></code> results</p>
</div>
</div>
<div class="section level2">
<h2 id="key-implementation-details">Key Implementation Details<a class="anchor" aria-label="anchor" href="#key-implementation-details"></a></h2>
<div class="section level3">
<h3 id="emergency-rule-logic">Emergency Rule Logic<a class="anchor" aria-label="anchor" href="#emergency-rule-logic"></a></h3>
<p>If a factor has zero loadings above cutoff: - Uses top <code>n_emergency</code> highest absolute loadings instead - Clearly marked with WARNING in output - Prevents empty factor interpretations</p>
</div>
<div class="section level3">
<h3 id="word-limit-enforcement">Word Limit Enforcement<a class="anchor" aria-label="anchor" href="#word-limit-enforcement"></a></h3>
<p>Targets 80-100% of <code>word_limit</code> parameter: - System prompt includes explicit word targets - Post-processing validates and <strong>informs</strong> (via <code><a href="https://cli.r-lib.org/reference/cli_abort.html" class="external-link">cli::cli_inform()</a></code>) if exceeded - Helper function <code><a href="reference/count_words.html">count_words()</a></code> in utils.R - <strong>Note</strong>: Changed from warning to message (2025-11-03) to reduce test noise</p>
</div>
<div class="section level3">
<h3 id="json-parsing-strategy">JSON Parsing Strategy<a class="anchor" aria-label="anchor" href="#json-parsing-strategy"></a></h3>
<p>Multi-tiered fallback for robust LLM response handling: 1. Try parsing cleaned JSON (remove extra text, fix formatting) 2. Fall back to original response 3. Pattern-based extraction if JSON parsing fails 4. Default values if all methods fail</p>
<p>Critical for handling small/local models with imperfect JSON output.</p>
</div>
<div class="section level3">
<h3 id="system-prompt-synchronization">System Prompt Synchronization<a class="anchor" aria-label="anchor" href="#system-prompt-synchronization"></a></h3>
<p>The psychometric expert system prompt is defined in <strong>TWO locations</strong>: - <code>interpret_fa.R</code> (lines ~294-330): Single-use sessions - <code>chat_fa.R</code> (lines ~57-73): Persistent sessions</p>
<p><strong>CRITICAL</strong>: Keep both prompts synchronized when making changes.</p>
</div>
</div>
<div class="section level2">
<h2 id="exported-functions-and-methods">Exported Functions and Methods<a class="anchor" aria-label="anchor" href="#exported-functions-and-methods"></a></h2>
<p><strong>9 exported functions:</strong> - <code><a href="reference/interpret_fa.html">interpret_fa()</a></code> - Core factor interpretation with LLM - <code><a href="reference/interpret.html">interpret()</a></code> - S3 generic for common FA packages - <code><a href="reference/chat_fa.html">chat_fa()</a></code>, <code><a href="reference/is.chat_fa.html">is.chat_fa()</a></code>, <code><a href="reference/reset.chat_fa.html">reset.chat_fa()</a></code> - Session management - <code><a href="reference/find_cross_loadings.html">find_cross_loadings()</a></code>, <code><a href="reference/find_no_loadings.html">find_no_loadings()</a></code> - Diagnostic utilities - <code><a href="reference/export_interpretation.html">export_interpretation()</a></code> - Export to txt/md formats - <code><a href="reference/create_factor_plot.html">create_factor_plot()</a></code> - Plotting wrapper</p>
<p><strong>10 S3 methods:</strong> - <code><a href="reference/interpret.fa.html">interpret.fa()</a></code>, <code><a href="reference/interpret.principal.html">interpret.principal()</a></code>, <code><a href="reference/interpret.lavaan.html">interpret.lavaan()</a></code>, <code><a href="reference/interpret.efaList.html">interpret.efaList()</a></code>, <code><a href="reference/interpret.SingleGroupClass.html">interpret.SingleGroupClass()</a></code>, <code>interpret.psych()</code>, <code>interpret.default()</code> - <code><a href="reference/print.fa_interpretation.html">print.fa_interpretation()</a></code>, <code><a href="reference/print.chat_fa.html">print.chat_fa()</a></code> - <code><a href="reference/plot.fa_interpretation.html">plot.fa_interpretation()</a></code></p>
</div>
<div class="section level2">
<h2 id="dependencies">Dependencies<a class="anchor" aria-label="anchor" href="#dependencies"></a></h2>
<p><strong>Imports (required):</strong> - <code>ellmer</code> - LLM communication - <code>dplyr</code>, <code>tidyr</code> - Data manipulation - <code>ggplot2</code> - Visualization - <code>cli</code> - User messaging - <code>jsonlite</code> - JSON parsing</p>
<p><strong>Suggests (optional):</strong> - <code>psych</code>, <code>lavaan</code>, <code>mirt</code> - For S3 method support - <code>testthat</code> - Testing framework - <code>knitr</code>, <code>rmarkdown</code> - Vignettes</p>
</div>
<div class="section level2">
<h2 id="code-style-conventions">Code Style Conventions<a class="anchor" aria-label="anchor" href="#code-style-conventions"></a></h2>
<ul><li>
<strong>Roxygen2 documentation</strong>: Required for all exported functions</li>
<li>
<strong>Explicit namespacing</strong>: Use <code>package::function()</code> (e.g., <code><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">dplyr::mutate()</a></code>)</li>
<li>
<strong>CLI messaging</strong>: Use <code>cli</code> package (<code>cli_alert_info</code>, <code>cli_abort</code>, <code>cli_inform</code>)</li>
<li>
<strong>Pipe operator</strong>: Base R <code>|&gt;</code> (not magrittr <code>%&gt;%</code>)</li>
<li>
<strong>Parameter validation</strong>: Extensive validation with informative errors at function start</li>
</ul></div>
<div class="section level2">
<h2 id="testing">Testing<a class="anchor" aria-label="anchor" href="#testing"></a></h2>
<p><strong>70 tests</strong> across 7 files following <a href="https://r-pkgs.org/testing-design.html" class="external-link">R Packages 2e</a> best practices:</p>
<p><strong>Test files:</strong> - <code>test-chat_fa.R</code> - Chat session management and token tracking - <code>test-export_functions.R</code> - Export to txt/md formats - <code>test-fa_utilities.R</code> - Cross-loading and no-loading detection - <code>test-interpret_fa.R</code> - Core interpretation logic, emergency rules - <code>test-interpret_methods.R</code> - S3 methods for psych/lavaan/mirt - <code>test-print_methods.R</code> - Print methods - <code>test-visualization.R</code> - Plot methods and heatmap generation</p>
<p><strong>Test infrastructure:</strong> - Uses <code>testthat 3.0</code> framework - Fixtures stored in <code>tests/testthat/fixtures/</code> as <code>.rds</code> files - Helper functions in <code>helper.R</code> use <code>test_path()</code> for portability - LLM-requiring tests skip automatically on CI (GitHub Actions) - Token-efficient fixtures: <code>minimal_*</code> fixtures use <code>word_limit = 20</code> (minimum allowed)</p>
<p><strong>Three fixture sets:</strong> 1. <strong>Standard fixtures</strong>: 5 variables × 3 factors (~400-500 tokens) 2. <strong>Minimal fixtures</strong>: 3 variables × 2 factors (~150-200 tokens, 60-70% reduction) 3. <strong>Correlational fixtures</strong>: Realistic FA data with proper factor structure (eliminates Heywood case warnings)</p>
</div>
<div class="section level2">
<h2 id="file-organization">File Organization<a class="anchor" aria-label="anchor" href="#file-organization"></a></h2>
<pre><code>R/
├── interpret_fa.R          # Main interpretation function (~1350 lines)
├── chat_fa.R               # Persistent chat session management
├── interpret_methods.R     # S3 methods for psych/lavaan/mirt
├── fa_utilities.R          # Cross-loading &amp; no-loading detection
├── utils.R                 # Word counting, text wrapping
├── fa_report_functions.R   # Report building, print methods
├── export_functions.R      # Export to txt/md formats
└── visualization.R         # S3 plot method and heatmap creation

tests/testthat/
├── fixtures/               # Test data as .rds files
│   ├── sample_*.rds        # Standard fixtures (5 vars × 3 factors)
│   ├── minimal_*.rds       # Token-efficient fixtures (3 vars × 2 factors)
│   ├── correlational_*.rds # Realistic FA data (6 vars × 2 factors)
│   └── make-*.R            # Regeneration scripts
├── helper.R                # Test helper functions
└── test-*.R                # 7 test files (70 tests total)</code></pre>
</div>
<div class="section level2">
<h2 id="common-development-commands">Common Development Commands<a class="anchor" aria-label="anchor" href="#common-development-commands"></a></h2>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Documentation</span></span>
<span><span class="fu">roxygen2</span><span class="fu">::</span><span class="fu"><a href="https://roxygen2.r-lib.org/reference/roxygenize.html" class="external-link">roxygenise</a></span><span class="op">(</span><span class="op">)</span>       <span class="co"># Generate docs from roxygen2 comments</span></span>
<span><span class="fu">devtools</span><span class="fu">::</span><span class="fu"><a href="https://devtools.r-lib.org/reference/document.html" class="external-link">document</a></span><span class="op">(</span><span class="op">)</span>         <span class="co"># Alternative</span></span>
<span></span>
<span><span class="co"># Testing</span></span>
<span><span class="fu">devtools</span><span class="fu">::</span><span class="fu"><a href="https://devtools.r-lib.org/reference/test.html" class="external-link">test</a></span><span class="op">(</span><span class="op">)</span>             <span class="co"># Run all tests</span></span>
<span><span class="fu">testthat</span><span class="fu">::</span><span class="fu"><a href="https://testthat.r-lib.org/reference/test_file.html" class="external-link">test_file</a></span><span class="op">(</span><span class="st">"tests/testthat/test-interpret_fa.R"</span><span class="op">)</span>  <span class="co"># Single file</span></span>
<span></span>
<span><span class="co"># Checking</span></span>
<span><span class="fu">devtools</span><span class="fu">::</span><span class="fu"><a href="https://devtools.r-lib.org/reference/check.html" class="external-link">check</a></span><span class="op">(</span><span class="op">)</span>            <span class="co"># Run R CMD check</span></span>
<span><span class="fu">devtools</span><span class="fu">::</span><span class="fu"><a href="https://devtools.r-lib.org/reference/install.html" class="external-link">install</a></span><span class="op">(</span><span class="op">)</span>          <span class="co"># Install locally</span></span>
<span><span class="fu">devtools</span><span class="fu">::</span><span class="fu"><a href="https://devtools.r-lib.org/reference/load_all.html" class="external-link">load_all</a></span><span class="op">(</span><span class="op">)</span>         <span class="co"># Load for development</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="common-workflows">Common Workflows<a class="anchor" aria-label="anchor" href="#common-workflows"></a></h2>
<div class="section level3">
<h3 id="using-s3-methods-with-fa-packages">Using S3 Methods with FA Packages<a class="anchor" aria-label="anchor" href="#using-s3-methods-with-fa-packages"></a></h3>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># psych package</span></span>
<span><span class="va">fa_result</span> <span class="op">&lt;-</span> <span class="fu">psych</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/psych/man/fa.html" class="external-link">fa</a></span><span class="op">(</span><span class="va">data</span>, nfactors <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span>
<span><span class="va">interpretation</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/interpret.html">interpret</a></span><span class="op">(</span><span class="va">fa_result</span>,</span>
<span>                           variable_info <span class="op">=</span> <span class="va">var_descriptions</span>,</span>
<span>                           llm_provider <span class="op">=</span> <span class="st">"anthropic"</span>,</span>
<span>                           llm_model <span class="op">=</span> <span class="st">"claude-haiku-4-5-20251001"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># lavaan package</span></span>
<span><span class="va">efa_result</span> <span class="op">&lt;-</span> <span class="fu">lavaan</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/lavaan/man/efa.html" class="external-link">efa</a></span><span class="op">(</span><span class="va">data</span>, nfactors <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span>
<span><span class="va">interpretation</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/interpret.html">interpret</a></span><span class="op">(</span><span class="va">efa_result</span>, variable_info <span class="op">=</span> <span class="va">var_descriptions</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># mirt package</span></span>
<span><span class="va">mirt_result</span> <span class="op">&lt;-</span> <span class="fu">mirt</span><span class="fu">::</span><span class="fu"><a href="https://philchalmers.github.io/mirt/reference/mirt.html" class="external-link">mirt</a></span><span class="op">(</span><span class="va">data</span>, <span class="fl">2</span>, itemtype <span class="op">=</span> <span class="st">"2PL"</span><span class="op">)</span></span>
<span><span class="va">interpretation</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/interpret.html">interpret</a></span><span class="op">(</span><span class="va">mirt_result</span>, variable_info <span class="op">=</span> <span class="va">var_descriptions</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="visualizing-results">Visualizing Results<a class="anchor" aria-label="anchor" href="#visualizing-results"></a></h3>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Get interpretation</span></span>
<span><span class="va">results</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/interpret_fa.html">interpret_fa</a></span><span class="op">(</span><span class="va">loadings</span>, <span class="va">variable_info</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Plot with S3 method (recommended)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">results</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Or use backward-compatible wrapper</span></span>
<span><span class="fu"><a href="reference/create_factor_plot.html">create_factor_plot</a></span><span class="op">(</span><span class="va">results</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Save and customize</span></span>
<span><span class="va">p</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">results</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Custom Title"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>axis.text.y <span class="op">=</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">8</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu">ggsave</span><span class="op">(</span><span class="st">"loadings.png"</span>, <span class="va">p</span>, width <span class="op">=</span> <span class="fl">10</span>, height <span class="op">=</span> <span class="fl">8</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="token-efficient-multi-analysis-workflow">Token-Efficient Multi-Analysis Workflow<a class="anchor" aria-label="anchor" href="#token-efficient-multi-analysis-workflow"></a></h3>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Create persistent session (saves system prompt)</span></span>
<span><span class="va">chat</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/chat_fa.html">chat_fa</a></span><span class="op">(</span><span class="st">"anthropic"</span>, <span class="st">"claude-haiku-4-5-20251001"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Interpret multiple analyses</span></span>
<span><span class="va">results1</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/interpret_fa.html">interpret_fa</a></span><span class="op">(</span><span class="va">loadings1</span>, <span class="va">var_info1</span>, chat_session <span class="op">=</span> <span class="va">chat</span><span class="op">)</span></span>
<span><span class="va">results2</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/interpret_fa.html">interpret_fa</a></span><span class="op">(</span><span class="va">loadings2</span>, <span class="va">var_info2</span>, chat_session <span class="op">=</span> <span class="va">chat</span><span class="op">)</span></span>
<span><span class="va">results3</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/interpret_fa.html">interpret_fa</a></span><span class="op">(</span><span class="va">loadings3</span>, <span class="va">var_info3</span>, chat_session <span class="op">=</span> <span class="va">chat</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Check token usage</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">chat</span><span class="op">)</span>  <span class="co"># Shows cumulative tokens and n_interpretations</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="debugging-tips">Debugging Tips<a class="anchor" aria-label="anchor" href="#debugging-tips"></a></h2>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Enable LLM prompt/response visibility</span></span>
<span><span class="fu"><a href="reference/interpret_fa.html">interpret_fa</a></span><span class="op">(</span><span class="va">...</span>, echo <span class="op">=</span> <span class="st">"all"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Check token usage</span></span>
<span><span class="va">chat</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/chat_fa.html">chat_fa</a></span><span class="op">(</span><span class="st">"anthropic"</span>, <span class="st">"claude-haiku-4-5-20251001"</span><span class="op">)</span></span>
<span><span class="va">result</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/interpret_fa.html">interpret_fa</a></span><span class="op">(</span><span class="va">...</span>, chat_session <span class="op">=</span> <span class="va">chat</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">chat</span><span class="op">)</span>  <span class="co"># Displays token counts</span></span>
<span></span>
<span><span class="co"># Validate JSON parsing</span></span>
<span><span class="co"># Look for messages about word limit exceedances or JSON parsing issues</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="llm-provider-configuration">LLM Provider Configuration<a class="anchor" aria-label="anchor" href="#llm-provider-configuration"></a></h2>
<p>API keys must be set as environment variables:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Sys.setenv.html" class="external-link">Sys.setenv</a></span><span class="op">(</span>OPENAI_API_KEY <span class="op">=</span> <span class="st">"your-key"</span><span class="op">)</span>      <span class="co"># OpenAI</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Sys.setenv.html" class="external-link">Sys.setenv</a></span><span class="op">(</span>ANTHROPIC_API_KEY <span class="op">=</span> <span class="st">"your-key"</span><span class="op">)</span>   <span class="co"># Anthropic</span></span>
<span><span class="co"># Ollama (local): no key needed</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="extending-the-package">Extending the Package<a class="anchor" aria-label="anchor" href="#extending-the-package"></a></h2>
<div class="section level3">
<h3 id="adding-new-output-formats-to-export_interpretation">Adding New Output Formats to export_interpretation()<a class="anchor" aria-label="anchor" href="#adding-new-output-formats-to-export_interpretation"></a></h3>
<ol style="list-style-type: decimal"><li>Add format to switch statement (export_functions.R:~93)</li>
<li>Implement format-specific logic</li>
<li>Update documentation</li>
</ol></div>
<div class="section level3">
<h3 id="modifying-report-formats">Modifying Report Formats<a class="anchor" aria-label="anchor" href="#modifying-report-formats"></a></h3>
<p>Report generation in <code>build_fa_report()</code> (fa_report_functions.R:~18) supports: - <code>output_format</code>: “text” or “markdown” - <code>heading_level</code>: For markdown hierarchy - <code>suppress_heading</code>: For embedding in documents</p>
</div>
</div>
<div class="section level2">
<h2 id="recent-key-updates">Recent Key Updates<a class="anchor" aria-label="anchor" href="#recent-key-updates"></a></h2>
<div class="section level3">
<h3 id="id_2025-11-04">2025-11-04<a class="anchor" aria-label="anchor" href="#id_2025-11-04"></a></h3>
<ul><li>✓ <strong>System prompt token tracking</strong>: Fixed token tracking for persistent chat sessions. System prompt tokens are now correctly captured on first use (when first message is sent) rather than at initialization. Added <code>system_prompt_captured</code> flag to track whether tokens have been extracted.</li>
</ul></div>
<div class="section level3">
<h3 id="id_2025-11-03">2025-11-03<a class="anchor" aria-label="anchor" href="#id_2025-11-03"></a></h3>
<ul><li>✓ <strong>Token tracking fix</strong>: Dual-tier system prevents negative accumulation</li>
<li>✓ <strong>S3 method system</strong>: <code><a href="reference/interpret.html">interpret()</a></code> generic for psych/lavaan/mirt packages</li>
<li>✓ <strong>Export simplification</strong>: Only txt/md formats (removed CSV/JSON/RDS)</li>
<li>✓ <strong>Test fixtures</strong>: Three sets (standard, minimal, correlational) for comprehensive testing</li>
<li>✓ <strong>Word limit messaging</strong>: Changed from <code>cli_warn()</code> to <code>cli_inform()</code> for less noise</li>
<li>✓ <strong>Parameter limits relaxed</strong>: <code>word_limit</code> minimum 20→20, <code>max_line_length</code> max 200→300</li>
</ul></div>
</div>
<div class="section level2">
<h2 id="future-features">Future Features<a class="anchor" aria-label="anchor" href="#future-features"></a></h2>
<ul><li>Additional interpretation classes:
<ul><li>Cluster analysis</li>
<li>IRT models (item diagnostics focus)</li>
<li>CDM models (q-matrix interpretation)</li>
</ul></li>
</ul></div>
<div class="section level2">
<h2 id="todos">TODOs<a class="anchor" aria-label="anchor" href="#todos"></a></h2>
<ul><li>Token tracking fix implemented
<ul><li>docs, code comments, and tests reviewed and updated to reflect behavior</li>
<li>NOTE: <code>system_prompt</code> tokens are not reliably reported by the <code>ellmer</code> wrapper for some providers (this appears to be an upstream bug). For accuracy and to avoid double-counting or negative accumulation, <code>psychinterpreter</code> intentionally does NOT add <code>system_prompt</code> tokens to the package-level cumulative token counters. Instead, per-run tokens are computed from roles reported by <code>ellmer::chat$get_tokens()</code> (user/assistant). If you need provider-specific system-prompt token counts, call <code>chat$chat$get_tokens(include_system_prompt = TRUE)</code> directly but be aware results may be inconsistent across providers.</li>
</ul></li>
<li>prepare package class system for future classes which may include “gm” (gaussian mixture model), “irt” (item response theory), and “cdm” (cognitive diagnosis models)
<ul><li>analyze potential refactoring and modularization of existing codebase to improve maintainability and scalability</li>
<li>rename and refactor code base</li>
</ul></li>
</ul></div>
<div class="section level2">
<h2 id="known-issues">Known Issues<a class="anchor" aria-label="anchor" href="#known-issues"></a></h2>
<p>None currently.</p>
</div>
<div class="section level2">
<h2 id="version--license">Version &amp; License<a class="anchor" aria-label="anchor" href="#version--license"></a></h2>
<ul><li>
<strong>Version</strong>: 0.0.0.9000 (development)</li>
<li>
<strong>R requirement</strong>: &gt;= 4.1.0</li>
<li>
<strong>License</strong>: MIT + file LICENSE</li>
</ul></div>
</div>

  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by Matthias Kloft.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer></div>





  </body></html>

